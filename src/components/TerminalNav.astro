---
const navItems = [
    { name: "intro", href: "#hero", label: "01" },
    { name: "github", href: "#dashboard", label: "02" },
    { name: "blog", href: "#blog", label: "03" },
    { name: "media", href: "#media", label: "04" },
    { name: "social", href: "#social", label: "05" },
];
---

<header id="terminal-nav" class="fixed top-0 left-0 right-0 z-[100] transition-transform duration-300">
    <nav class="mx-4 mt-4 md:mx-10 rounded-xl border border-gray-700 bg-black/95 backdrop-blur-xl shadow-2xl">
        <!-- Terminal Header Bar -->
        <div class="flex items-center justify-between px-4 py-2 border-b border-gray-800/50">
            <div class="flex items-center gap-3">
                <div class="flex gap-1.5">
                    <span class="w-3 h-3 rounded-full bg-red-500/80"></span>
                    <span class="w-3 h-3 rounded-full bg-yellow-500/80"></span>
                    <span class="w-3 h-3 rounded-full bg-green-500/80"></span>
                </div>
                <span id="ai-trigger" class="font-mono text-xs text-gray-400 hidden sm:inline cursor-pointer hover:text-accent transition-colors group" title="Ask AI about me">
                    altaskur@portfolio:~
                    <span class="text-accent/60 group-hover:text-accent animate-pulse">[?]</span>
                </span>
            </div>
            
            <!-- Mobile Menu Toggle -->
            <button id="nav-toggle" class="md:hidden text-gray-400 hover:text-accent transition-colors focus:outline-none focus:ring-2 focus:ring-accent" aria-label="Open navigation menu" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
            
            <!-- Desktop Navigation -->
            <div class="hidden md:flex items-center gap-1">
                {navItems.map((item) => (
                    <a 
                        href={item.href} 
                        class="nav-link group flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-gray-400 hover:text-accent hover:bg-gray-800/50 transition-all font-mono text-sm"
                        data-section={item.href.replace('#', '')}
                    >
                        <span class="text-accent/60 text-xs">{item.label}.</span>
                        <span class="group-hover:text-white transition-colors">{item.name}</span>
                    </a>
                ))}
            </div>
        </div>
        
        <!-- Mobile Navigation (Hidden by default) -->
        <div id="mobile-nav" class="hidden md:hidden px-4 py-3 space-y-1">
            {navItems.map((item) => (
                <a 
                    href={item.href} 
                    class="mobile-nav-link flex items-center gap-2 px-3 py-2 rounded-lg text-gray-400 hover:text-accent hover:bg-gray-800/50 transition-all font-mono text-sm"
                >
                    <span class="text-accent">{item.label}.</span>
                    <span>cd ~/{item.name}</span>
                </a>
            ))}
        </div>
    </nav>
</header>

<script>
    import { gsap } from "gsap";
    import { ScrollTrigger } from "gsap/ScrollTrigger";

    gsap.registerPlugin(ScrollTrigger);

    // AI Terminal trigger
    function setupAITrigger() {
        const aiTrigger = document.getElementById('ai-trigger');
        if (aiTrigger) {
            // Clone to remove existing listeners
            const newTrigger = aiTrigger.cloneNode(true);
            aiTrigger.parentNode?.replaceChild(newTrigger, aiTrigger);
            
            newTrigger.addEventListener('click', () => {
                if (typeof (window as any).openAITerminal === 'function') {
                    (window as any).openAITerminal();
                }
            });
        }
    }

    const initTerminalNav = () => {
        const header = document.getElementById('terminal-nav');
        const navToggle = document.getElementById('nav-toggle');
        const mobileNav = document.getElementById('mobile-nav');
        const navLinks = document.querySelectorAll('.nav-link, .mobile-nav-link');

        // Mobile menu toggle - Fix using clone to prevent double listeners
        if (navToggle && mobileNav) {
            const newToggle = navToggle.cloneNode(true);
            navToggle.parentNode?.replaceChild(newToggle, navToggle);
            
            newToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                mobileNav.classList.toggle('hidden');
                console.log('Mobile menu toggled', mobileNav.classList.contains('hidden'));
            });

            // Click outside to close
            document.addEventListener('click', (e) => {
                if (!mobileNav.classList.contains('hidden') && 
                    !newToggle.contains(e.target as Node) && 
                    !mobileNav.contains(e.target as Node)) {
                    mobileNav.classList.add('hidden');
                }
            });
        }

        // Close mobile menu on link click
        document.querySelectorAll('.mobile-nav-link').forEach(link => {
            link.addEventListener('click', () => {
                mobileNav?.classList.add('hidden');
            });
        });

        // Smooth scroll for anchor links
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const href = link.getAttribute('href');
                if (href) {
                    const target = document.querySelector(href);
                    if (target) {
                        const offset = 100;
                        const top = target.getBoundingClientRect().top + window.scrollY - offset;
                        window.scrollTo({ top, behavior: 'smooth' });
                    }
                }
            });
        });

        // Active section highlighting
        const sections = ['hero', 'dashboard', 'blog', 'media', 'social'];
        
        sections.forEach(sectionId => {
            const section = document.getElementById(sectionId);
            if (section) {
                ScrollTrigger.create({
                    trigger: section,
                    start: 'top center',
                    end: 'bottom center',
                    onEnter: () => highlightNav(sectionId),
                    onEnterBack: () => highlightNav(sectionId)
                });
            }
        });

        function highlightNav(sectionId: string) {
            navLinks.forEach(link => {
                const linkSection = link.getAttribute('data-section') || link.getAttribute('href')?.replace('#', '');
                if (linkSection === sectionId) {
                    link.classList.add('text-accent', 'bg-gray-800/50');
                    link.classList.remove('text-gray-400');
                } else {
                    link.classList.remove('text-accent', 'bg-gray-800/50');
                    link.classList.add('text-gray-400');
                }
            });
        }

        // Initial entrance animation - wait for boot screen to finish
        gsap.set(header, { y: -50, opacity: 0 });
        gsap.to(header, {
            y: 0,
            opacity: 1,
            duration: 0.6,
            delay: 2, // Wait for boot screen animation
            ease: 'power3.out'
        });

        // Setup AI Trigger
        setupAITrigger();
    };

    // Use Astro page-load for View Transitions compatibility
    document.addEventListener('astro:page-load', initTerminalNav);
    // Fallback for initial load if not using View Transitions
    if (!document.documentElement.dataset.hasAstroListeners) {
        document.addEventListener('DOMContentLoaded', initTerminalNav);
        document.documentElement.dataset.hasAstroListeners = 'true';
    }
</script>
